import{_ as ye}from"./DdI5B-f_.js";import{q as le,r as i,s as ne,V as ve,v as ge,h as ee,M as Q,o as c,x as _,w as t,B as l,c as q,t as ie,b as o,d as y,X as oe,D as U,Y as z,A as we,a as E,an as ae,C as te,F as se,ao as ke}from"./pfen37nC.js";import{H as xe,L as re,_ as he}from"./DjzlFm1z.js";import{u as Ce}from"./yaBYm9bp.js";import{_ as be}from"./BCgTLb-1.js";import{c as b}from"./BbeeQSgS.js";import{r as W}from"./CHxyi5eo.js";import{S as Ue,a as Fe,b as Se,P as $e}from"./B8DQizlv.js";import{B as ce}from"./DaTCy0-P.js";import{S as Re,a as Be}from"./BIMQPg20.js";import{I as de,_ as Ie,a as Le,F as Me}from"./BILk8unQ.js";import{M as Oe}from"./DO5rWUxn.js";import{S as pe,_ as qe}from"./4efXhTML.js";import{M as ue}from"./hDKACIxK.js";import{_ as Ee}from"./CL9W64Bf.js";import"./CgdMqucG.js";import"./CuvLPzjN.js";import"./D73PgFZk.js";import"./D5PK9cSD.js";import"./zumCF4Wn.js";import"./CuwMMC_f.js";import"./C5j99dGK.js";import"./D6oZlt4w.js";import"./DGYNie3Z.js";import"./YQznkyEo.js";import"./DL8rJm5r.js";import"./ZEWPwqxo.js";import"./CXPWXIeg.js";import"./vCu2co3e.js";const je={key:1},ze=le({__name:"CompanyModal",props:{open:{type:Boolean},isEditing:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},item:{default:()=>({})},title:{default:"Добавление пользователя"},roles:{}},emits:["close","confirm"],setup(Z,{emit:w}){const p=i(!1),P=ne(),B=Z,{copy:A}=Ce(),{open:v,isEditing:k,isLoading:F,item:I,roles:x}=ve(B),S=w,h=i(null),G=async()=>{var e;p.value=!0;try{const s=await((e=h.value)==null?void 0:e.validateFields());if(s&&!s.errorFields){const C={password:r.password,confirm_password:r.confirm_password,name:r.username,email:r.email,role_id:r.role},d=await b.updateUser(C);console.log("rest: ",d),S("confirm",d)}}catch{z.error("Непредвиденная ошибка")}finally{p.value=!1}},D=async()=>{var e,s,C;p.value=!0;try{const d=await((e=h.value)==null?void 0:e.validateFields());if(d&&!d.errorFields){const f={password:r.password,name:r.username,email:r.email,confirm_password:r.password,role:"user"},u=await b.registerUser(f);if(!u)z.error("Пользователь уже зарегистрирован!");else{const M={company_id:P.getUser.owner.id,user_id:((C=(s=u==null?void 0:u.data)==null?void 0:s.user)==null?void 0:C.id)??null},O=await b.addUser(M);await W.addRoleToUser({role_id:r.role,user_id:u.data.user.id}),S("confirm",O)}}}catch{z.error("Непредвиденная ошибка")}finally{p.value=!1}},N=()=>{S("close")},r=ge({username:"",email:"",password:"",role:null,confirm_password:""});i(null);const H=i(null),T=i(null);ee(()=>I.value,e=>{console.log(e),k.value&&e&&(r.username=(e==null?void 0:e.name)??"",r.email=(e==null?void 0:e.email)??"",r.role=x.value.find(s=>s.role===(e==null?void 0:e.company_role)).id,r.password=(e==null?void 0:e.password)??"")},{immediate:!0}),ee(()=>v.value,e=>{e&&(r.username="",r.email="",r.password=""),e||(h.value.resetFields(),$.value&&(H.value.resetForm(),$.value=!1),R.value&&(T.value.resetForm(),R.value=!1))});const $=i(!1),R=i(!1),j=()=>{R.value=!R.value},K=()=>{$.value=!$.value},L=e=>{try{A(e),z.success("Данные скопированы")}catch{z.error("Ошибка копирования")}},X=e=>{console.log(`selected ${e}`),r.role=e},Y=(e,s)=>s.label.toLowerCase().indexOf(e.toLowerCase())>=0,a=Q(()=>x.value.map(e=>({label:e.role,value:e.id})));return(e,s)=>{const C=Ue,d=ce,f=Ee,u=Fe,M=Se,O=Re,n=de,g=Ie,J=Oe,me=pe,V=Le,fe=Me,_e=ue;return c(),_(_e,{open:l(v),onCancel:N,onOk:D},{title:t(()=>[l(F)?(c(),_(C,{key:0,paragraph:{rows:0},active:""})):(c(),q("div",je,ie(e.title),1))]),footer:t(()=>[l(k)?(c(),_(f,{key:0,justify:"space-between",wrap:"wrap"},{default:t(()=>[o(d,{type:"link",danger:""},{default:t(()=>[y("Удалить пользователя")]),_:1}),o(d,{type:"primary",onClick:G},{default:t(()=>[y("Сохранить")]),_:1})]),_:1})):(c(),_(d,{key:"submit",type:"primary",loading:p.value,onClick:D},{default:t(()=>[y("Добавить пользователя")]),_:1},8,["loading"]))]),default:t(()=>[l(F)?(c(),_(O,{key:0,class:"w-[250px]",direction:"vertical"},{default:t(()=>[o(f,{justify:"space-between",wrap:"wrap"},{default:t(()=>[o(u,{active:""})]),_:1}),o(f,{justify:"space-between",wrap:"wrap"},{default:t(()=>[o(u,{active:""}),o(M,{active:""})]),_:1}),o(f,{justify:"space-between",wrap:"wrap"},{default:t(()=>[o(u,{class:"flex-grow",active:""})]),_:1}),o(f,{justify:"space-between",wrap:"wrap"},{default:t(()=>[o(u,{class:"flex-grow",active:""}),o(M,{active:""})]),_:1})]),_:1})):(c(),_(fe,{key:1,ref_key:"clusterModal",ref:h,layout:"vertical",model:r,name:"basic",autocomplete:"off"},{default:t(()=>[o(g,{name:"username",class:"w-[340px]",rules:[{required:!0,message:"Введите имя пользователя"}]},{default:t(()=>[o(n,{value:r.username,"onUpdate:value":s[0]||(s[0]=m=>r.username=m),class:"text-gray-400",placeholder:"Имя пользователя"},{prefix:t(()=>[o(l(xe),{size:20,color:"currentColor"})]),_:1},8,["value"])]),_:1}),o(g,{name:"email",rules:{required:!0,type:"email",message:"Введите E-mail!"}},{default:t(()=>[o(n,{value:r.email,"onUpdate:value":s[1]||(s[1]=m=>r.email=m),placeholder:"E-mail"},{prefix:t(()=>[o(J)]),_:1},8,["value"])]),_:1}),o(g,{name:"role",rules:{required:!0,message:"Выберите роль"}},{default:t(()=>[o(me,{value:r.role,"onUpdate:value":s[2]||(s[2]=m=>r.role=m),"show-search":"",placeholder:"Выберите роль",options:l(a),"filter-option":Y,onChange:X},null,8,["value","options"])]),_:1}),o(f,{wrap:"wrap",gap:4},{default:t(()=>[o(g,{class:oe(l(k)?"w-full":"w-[340px]"),name:"password",rules:[{required:!0,message:"Введите пароль"}]},{default:t(()=>[o(V,{value:r.password,"onUpdate:value":s[3]||(s[3]=m=>r.password=m),class:"text-gray-400",placeholder:"Введите пароль"},{prefix:t(()=>[o(l(re),{size:20,color:"currentColor"})]),_:1},8,["value"])]),_:1},8,["class"]),l(k)?(c(),_(g,{key:0,class:oe(l(k)?"w-full":"w-[340px]"),name:"confirm_password"},{default:t(()=>[o(V,{value:r.confirm_password,"onUpdate:value":s[4]||(s[4]=m=>r.confirm_password=m),class:"text-gray-400",placeholder:"Введите новый пароль"},{prefix:t(()=>[o(l(re),{size:20,color:"currentColor"})]),_:1},8,["value"])]),_:1},8,["class"])):U("",!0),o(f,{gap:4},{default:t(()=>[o(d,{type:"primary",class:"flex-grow",ghost:"",onClick:s[5]||(s[5]=m=>K())},{default:t(()=>[y("Проверить")]),_:1}),o(d,{type:"primary",class:"flex-grow",ghost:"",onClick:s[6]||(s[6]=m=>j())},{default:t(()=>[y("Генерировать")]),_:1})]),_:1}),l(k)?U("",!0):(c(),_(d,{key:1,type:"primary",class:"flex-grow",ghost:"",onClick:s[7]||(s[7]=m=>L(r.password))},{default:t(()=>[y("Скопировать")]),_:1}))]),_:1}),$.value?(c(),_(he,{key:0,ref_key:"leaksFormRef",ref:H,class:"my-4"},null,512)):U("",!0),R.value?(c(),_(be,{key:1,ref_key:"generateFormRef",ref:T,class:"my-4"},null,512)):U("",!0)]),_:1},8,["model"]))]),_:1},8,["open"])}}}),Pe={class:"h-full"},De={class:"mt-4 pb-6 px-4 flex w-full items-center flex-wrap justify-between border-solid border-transparent border-b-gray-200 border-0 border-b-[1px]"},Ne={class:"max-w-[400px] mt-4 w-full"},He={class:"border-solid border-0 border-b-2 border-gray-400"},Te={class:"flex gap-2 items-center"},Ae=E("span",null,"Сортировка",-1),Ge={key:0},Ke={key:1},Co=le({__name:"index",setup(Z){const w=i(!1),p=ne(),P=i(null),B=i([]),A=async()=>{w.value=!0;try{const a=await b.show(p.getUser.owner.id);P.value=a}catch(a){console.log(a)}finally{w.value=!1}},v=async()=>{w.value=!0;try{const a=await b.users(p.getUser.owner.id);console.log(a),B.value=a.users}catch(a){console.log(a)}finally{w.value=!1}};we(async()=>{await p.profile(),await A(),await D(),await v()});const k=Q(()=>[{name:"ID",dataIndex:"id",key:"id"},{name:"Имя",dataIndex:"name",key:"name"},{title:"Email",dataIndex:"email",key:"email"},{title:"Роль",key:"company_role",dataIndex:"company_role"},{title:"Действия",key:"action"}]),F=i(!1),I=i(!1),x=i(!1),S=i(null),h=i([]),G=async a=>{try{console.log(a),N(),await v()}catch(e){console.log(e)}},D=async()=>{try{const a=await W.list(p.getUser.owner.id);h.value=a}catch(a){console.log(a)}},N=()=>{F.value=!1,I.value=!1,S.value=null},r=async a=>{try{return await b.fetchUserById({params:{company_id:p.getUser.owner.id,user_id:a}})}catch(e){console.log(e)}},H=async a=>{x.value=!0;try{const e=await r(a);e&&(F.value=!0,I.value=!0,S.value=e)}catch(e){console.log(e)}x.value=!1},T=()=>{F.value=!0},$=async a=>{ue.confirm({title:`Вы точно хотите удалить пользователя ${a.name}?`,icon:te(ke),async onOk(){try{await R(a.id),await v()}catch(e){console.log(e)}},onCancel(){}})},R=async a=>{try{const e={company_id:p.getUser.owner.id,user_id:a},s=await b.deleteUser(e);await v()}catch(e){console.log(e)}},j=i(""),K=async a=>{x.value=!0;try{if(!a.length)await v();else{const e=await b.searchUsers({find:a,company_id:p.getUser.owner.id});console.log(e),B.value=e}}catch(e){console.log(e)}finally{x.value=!1}},L=i(0),X=async a=>{w.value=!0;try{L.value=a,a!==0?B.value=await W.search(p.getUser.owner.id,a):await v()}catch(e){console.log(e)}w.value=!1},Y=Q(()=>{const a=h.value.map(e=>({label:e.role,value:e.id}));return[{label:"Все",value:0},...a]});return(a,e)=>{var O;const s=ce,C=ye,d=de,f=pe,u=qe,M=ze;return c(),q("div",Pe,[o(C,{class:"mt-4",title:`Компания ${((O=l(P))==null?void 0:O.name)??""}`},{right:t(()=>[o(s,{type:"primary",size:"middle",icon:te(l($e)),onClick:e[0]||(e[0]=n=>T())},{default:t(()=>[y("Добавить пользователя")]),_:1},8,["icon"])]),_:1},8,["title"]),E("div",null,[E("div",De,[E("div",Ne,[E("div",He,[o(d,{value:l(j),"onUpdate:value":e[1]||(e[1]=n=>ae(j)?j.value=n:null),bordered:!1,placeholder:"Поиск...",class:"text-gray-400",onChange:e[2]||(e[2]=n=>K(n.target.value))},{prefix:t(()=>[o(l(Be),{size:16,color:"currentColor"})]),_:1},8,["value"])])]),E("div",Te,[Ae,o(f,{value:l(L),"onUpdate:value":e[3]||(e[3]=n=>ae(L)?L.value=n:null),style:{width:"100px"},options:l(Y),onChange:e[4]||(e[4]=n=>X(n))},null,8,["value","options"])])]),o(u,{columns:l(k),"data-source":l(B)},{headerCell:t(({column:n})=>[n.key==="name"?(c(),q("span",Ge," Имя ")):U("",!0),n.key==="id"?(c(),q("span",Ke," ID ")):U("",!0)]),bodyCell:t(({column:n,record:g})=>[n.key==="company_role"?(c(),q(se,{key:0},[y(ie(g.company_role??"Роль не задана"),1)],64)):U("",!0),n.key==="action"?(c(),q(se,{key:1},[o(s,{type:"link",danger:"",onClick:J=>$(g)},{default:t(()=>[y("Удалить")]),_:2},1032,["onClick"]),o(s,{type:"link",onClick:J=>H(g.id)},{default:t(()=>[y("Редактировать")]),_:2},1032,["onClick"])],64)):U("",!0)]),_:1},8,["columns","data-source"])]),o(M,{open:l(F),"is-editing":l(I),"is-loading":l(x),roles:l(h),title:l(I)?"Радактировать пользователя":"Добавление пользователя",item:l(S),onClose:e[5]||(e[5]=n=>N()),onConfirm:e[6]||(e[6]=n=>G(n))},null,8,["open","is-editing","is-loading","roles","title","item"])])}}});export{Co as default};
